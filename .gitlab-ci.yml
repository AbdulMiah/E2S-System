image: node:latest

stages:
  - build
  - test

# api build:create_npmrc:
#   stage: test
#   script:
#     - cd api/
#     - pwd

#     - |
#       if  [ ! -f .npmrc ]; then echo .npmrc missing. Creating one now.
#         export NPM_PROJECT_URL=$(echo "$CI_PROJECT_URL" | sed "s/${CI_PROJECT_PATH//\//\\/}/api\/v4/g")
#         export NPM_REGISTRY_PATHS=$(echo "$CI_PROJECT_URL" | sed "s/${CI_PROJECT_PATH//\//\\/}/api\/v4/g")
#         export NPMRC_URL=$(echo "$NPM_REGISTRY_PATHS" | sed 's/[^:]*[:]//')
#         export NPMRC_INSTALL_URL=$(echo "$NPMRC_URL/packages/npm/:_authToken=$GITLAB_TOKEN")
#         export NPMRC_PUBLISH_URL=$(echo "$NPMRC_URL/projects/$CI_PROJECT_ID/packages/npm/:_authToken=$GITLAB_TOKEN")
#         export NPM_SCOPE=$(echo "$CI_PROJECT_PATH" | sed 's/[/].*$//')
#         echo "@$NPM_SCOPE:registry=$NPM_REGISTRY_PATHS/packages/npm/" >> .npmrc
#         echo "$NPMRC_INSTALL_URL" >> .npmrc
#         echo "$NPMRC_PUBLISH_URL" >> .npmrc
#       fi

#     - cat .npmrc
#     # - echo "//${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}">.npmrc
#     # - echo "@c2061455:registry=https://git.cardiff.ac.uk/api/v4/packages/npm/" >> .npmrc
#     # - echo "//git.cardiff.ac.uk/api/v4/packages/npm/:_authToken=$GITLAB_TOKEN" >> .npmrc

#     # - npm config set registry https://git.cardiff.ac.uk/api/v4/packages/npm/

#     - npm i #@c2061455/api
#     # - npm test readlink -f tests/
#   only:
#     - cicd
#   artifacts:
#     paths:
#       - .npmrc

ui unit tests:
  stage: test
  script:
    - echo "This is a test job for ui/"
    - cd ui/ 
    - pwd
    - npm i
    - npm test
  only:
    - cicd

api unit tests:
  stage: test
  script:
    - echo "This is a test job for api/"
    - cd api/ 
    - pwd
    - npm i
    - npm test readlink -f controllers/
    - npm test readlink -f services/
    - npm test find tests/ –maxdepth 1 –type f
  only:
    - cicd